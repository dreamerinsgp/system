# create_account 指令用法

## 概述

`create_account` 是 Solana System Program 的核心指令之一，用于创建一个新账户并分配初始 lamports（SOL）和存储空间。该指令会：
1. 从支付账户（payer）转移 lamports 到新账户
2. 为新账户分配指定的存储空间（space）
3. 将新账户的所有者（owner）设置为指定的程序地址

## 指令结构

### 指令数据格式

```rust
pub struct CreateAccountInstructionArgs {
    pub lamports: u64,        // 要转移的 lamports 数量
    pub space: u64,          // 账户数据空间大小（字节）
    pub program_address: Pubkey,  // 新账户的所有者程序地址
}
```

### 账户要求

指令需要 2 个账户：

1. **payer** (`[writable, signer]`)
   - 支付账户，必须签名
   - 必须有足够的 lamports 来支付转账和租金

2. **new_account** (`[writable, signer]`)
   - 新创建的账户，必须签名
   - 账户必须不存在（lamports = 0，data 为空，owner 为默认值）

## 使用方式

### 1. JavaScript/TypeScript 客户端

#### 基本用法

```typescript
import { getCreateAccountInstruction, SYSTEM_PROGRAM_ADDRESS } from '@solana/system-program';
import { generateKeyPairSigner } from '@solana/kit';

// 生成新账户密钥对
const newAccount = generateKeyPairSigner();

// 创建指令
const createAccountInstruction = getCreateAccountInstruction({
    payer: payerSigner,           // 支付账户签名者
    newAccount: newAccount,       // 新账户签名者
    lamports: 1000000n,            // 1 SOL (1,000,000 lamports)
    space: 42n,                   // 42 字节存储空间
    programAddress: SYSTEM_PROGRAM_ADDRESS,  // 所有者程序地址
});

// 添加到交易
const transaction = await createDefaultTransaction(client, payer);
const txWithInstruction = appendTransactionMessageInstruction(
    createAccountInstruction,
    transaction
);
await signAndSendTransaction(client, txWithInstruction);
```

#### 完整示例

```typescript
import {
    appendTransactionMessageInstruction,
    fetchEncodedAccount,
    generateKeyPairSigner,
    pipe,
} from '@solana/kit';
import { SYSTEM_PROGRAM_ADDRESS, getCreateAccountInstruction } from '@solana/system-program';

async function createAccountExample() {
    const client = createDefaultSolanaClient();
    const space = 42n;
    
    // 1. 准备账户和计算租金
    const [payer, newAccount, lamports] = await Promise.all([
        generateKeyPairSignerWithSol(client),
        generateKeyPairSigner(),
        client.rpc.getMinimumBalanceForRentExemption(space).send(),
    ]);

    // 2. 创建指令
    const createAccount = getCreateAccountInstruction({
        payer,
        newAccount,
        space,
        lamports,
        programAddress: SYSTEM_PROGRAM_ADDRESS,
    });

    // 3. 发送交易
    await pipe(
        await createDefaultTransaction(client, payer),
        tx => appendTransactionMessageInstruction(createAccount, tx),
        tx => signAndSendTransaction(client, tx),
    );

    // 4. 验证账户
    const fetchedAccount = await fetchEncodedAccount(client.rpc, newAccount.address);
    console.log('Created account:', {
        address: fetchedAccount.address,
        lamports: fetchedAccount.lamports,
        space: fetchedAccount.space,
        owner: fetchedAccount.programAddress,
    });
}
```

### 2. Rust 客户端

#### 基本用法

```rust
use solana_sdk::{
    instruction::Instruction,
    pubkey::Pubkey,
    system_instruction,
    system_program,
};

// 创建指令
let instruction = system_instruction::create_account(
    &payer_pubkey,        // 支付账户公钥
    &new_account_pubkey,  // 新账户公钥
    lamports,            // lamports 数量
    space,               // 存储空间（字节）
    &owner_program_id,   // 所有者程序 ID
);

// 添加到交易
let mut transaction = Transaction::new_with_payer(
    &[instruction],
    Some(&payer_pubkey),
);
```

#### 使用 Builder 模式

```rust
use system_program_client::CreateAccountBuilder;

let instruction = CreateAccountBuilder::new()
    .payer(payer_pubkey)
    .new_account(new_account_pubkey)
    .lamports(1_000_000)
    .space(42)
    .program_address(owner_program_id)
    .instruction();
```

### 3. Rust 程序内（CPI - Cross Program Invocation）

#### 使用 CPI Builder

```rust
use system_program_client::CreateAccountCpiBuilder;

// 在程序内创建账户
let cpi_accounts = CreateAccountCpiAccounts {
    payer: payer_account_info,
    new_account: new_account_info,
};

let cpi_args = CreateAccountInstructionArgs {
    lamports: 1_000_000,
    space: 42,
    program_address: owner_program_id,
};

let cpi_program = system_program_account_info;
let cpi = CreateAccountCpiBuilder::new(cpi_program)
    .payer(payer_account_info)
    .new_account(new_account_info)
    .lamports(1_000_000)
    .space(42)
    .program_address(owner_program_id)
    .invoke_signed(&[&[seed, &[bump]]])?;
```

#### 直接使用 system_program

```rust
use solana_program::{
    program::invoke_signed,
    system_instruction,
    account_info::AccountInfo,
};

// 创建指令
let create_account_ix = system_instruction::create_account(
    payer_account_info.key,
    new_account_info.key,
    lamports,
    space as u64,
    owner_program_id,
);

// 调用系统程序
invoke_signed(
    &create_account_ix,
    &[
        payer_account_info.clone(),
        new_account_info.clone(),
        system_program_account_info.clone(),
    ],
    &[&[seed, &[bump]]],  // PDA 签名种子
)?;
```

## 重要注意事项

### 1. 租金豁免（Rent Exemption）

创建账户时，通常需要转移足够的 lamports 以满足租金豁免要求：

```typescript
// JavaScript
const lamports = await client.rpc.getMinimumBalanceForRentExemption(space).send();
```

```rust
// Rust
let rent = Rent::get()?;
let lamports = rent.minimum_balance(space as usize);
```

### 2. 账户状态要求

新账户必须满足以下条件：
- `lamports == 0`（账户不存在或为空）
- `data.is_empty()`（没有数据）
- `owner == Pubkey::default()`（默认所有者）

如果账户已存在或已初始化，指令会失败并返回 `SystemError::AccountAlreadyInUse`。

### 3. 签名要求

- **payer** 必须是交易签名者
- **new_account** 必须是交易签名者（除非使用 PDA）

### 4. 使用 PDA（Program Derived Address）

当创建 PDA 账户时，需要使用 `invoke_signed` 并提供种子：

```rust
let (pda_address, bump) = Pubkey::find_program_address(
    &[b"my_seed"],
    program_id,
);

// 创建 PDA 账户
invoke_signed(
    &create_account_ix,
    &accounts,
    &[&[b"my_seed", &[bump]]],  // PDA 签名种子
)?;
```

### 5. 空间限制

账户数据空间不能超过 `MAX_PERMITTED_DATA_LENGTH`（通常为 10MB）。

## 错误处理

常见错误：

- `SystemError::AccountAlreadyInUse`: 账户已存在
- `SystemError::ResultWithNegativeLamports`: payer 余额不足
- `SystemError::InvalidAccountDataLength`: 请求的空间超过限制
- `InstructionError::MissingRequiredSignature`: 缺少必需的签名

## 实际应用场景

### 场景 1: 创建用户数据账户

```typescript
// 为用户创建个人数据存储账户
const userDataAccount = generateKeyPairSigner();
const userDataSpace = 200n; // 200 字节存储用户数据

const createUserData = getCreateAccountInstruction({
    payer: user,
    newAccount: userDataAccount,
    lamports: await client.rpc.getMinimumBalanceForRentExemption(userDataSpace).send(),
    space: userDataSpace,
    programAddress: MY_PROGRAM_ID,
});
```

### 场景 2: 在程序内创建配置账户

```rust
// 在程序内创建配置 PDA
let config_seeds = &[b"config", &[config_bump]];
let (config_pda, _) = Pubkey::find_program_address(config_seeds, program_id);

system_program::create_account(
    CpiContext::new_with_signer(
        ctx.accounts.system_program.to_account_info(),
        CreateAccount {
            from: ctx.accounts.payer.to_account_info(),
            to: ctx.accounts.config.to_account_info(),
        },
        &[config_seeds],
    ),
    rent.minimum_balance(Config::LEN),
    Config::LEN as u64,
    program_id,
)?;
```

## 相关指令

- `create_account_with_seed`: 使用种子创建账户（PDA）
- `allocate`: 仅为账户分配空间
- `assign`: 仅分配账户所有者

## 参考

- System Program 源码: `/root/agave/programs/system/src/system_processor.rs`
- JavaScript 客户端: `/root/system/clients/js/src/generated/instructions/createAccount.ts`
- Rust 客户端: `/root/system/clients/rust/src/generated/instructions/create_account.rs`
- 测试示例: `/root/system/clients/js/test/createAccount.test.ts`
